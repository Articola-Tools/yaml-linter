name: "New changes validation"

on:
    pull_request:  # yamllint disable-line rule:empty-values

jobs:
    validate-yaml-linter-image:
        runs-on: "ubuntu-latest"
        # NOTE: building and running Docker image of YAML linter take around 1 minute.
        # If this job takes more than 5 minutes, it means that something is wrong.
        timeout-minutes: 5
        steps:
            - name: "Checkout ${{ github.event.repository.name }}"
              uses: "actions/checkout@v4"

            - name: "Set up Docker Buildx"
              uses: "docker/setup-buildx-action@v3"

            - name: "Build YAML linter Docker image"
              uses: "docker/build-push-action@v6"
              with:
                  push: false
                  load: true
                  # NOTE: using another name to don't allow docker to download image from the internet in the next step.
                  tags: "local/yaml-linter-pr:latest"

                  # NOTE: there are few other options for the cache,
                  # see https://docs.docker.com/build/ci/github-actions/cache/#registry-cache

                  # ATTENTION: this string must be in CSV format, so don't add space after the comma.
                  cache-from: "type=registry,ref=ghcr.io/${{ github.repository_owner }}/yaml-linter:latest"
                  cache-to: "type=inline"
            - name: "Run local YAML linter"
              run: "docker run --rm -v ${{ github.workspace }}:/linter_workdir/repo local/yaml-linter-pr:latest"
